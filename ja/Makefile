
Dir ?= /tmp
export Dir
InstallDir ?= ${Dir}/texmf-dist

LATEX ?= platex -kanji=euc
include ../cmd.mk
Gcid ?= $(shell git log -1 --pretty=format:"%h %aI" | tr -d -- '-:+')
Lo = '\def\Gcid{'${Gcid}'}'

########################################

Name = familytree
Tgt = ${Dir}/${Name}-ja.pdf
Tex = $(addsuffix JA.tex, ${Name} lib individual sibling gens marriage)

Fig = fig1base fig1Ieyasu fig1Hidetada
Fig += fig2base fig2Hidetada fig2ival fig2cfg
Fig += fig3Hidetada fig3Ietsuna fig3Iemitsu
figLily = $(addprefix fig3Lily, 1 2 3 4) $(addprefix fig4Lily, 1 2 3 4)
Fig += fig4Hidetada fig4Ogou

figTY = $(addsuffix T, ${Fig}) $(addsuffix Y, ${Fig})
figTYPdf = $(addprefix ${Dir}/, $(addsuffix .pdf, ${figTY}))
figPdf = $(addprefix ${Dir}/, $(addsuffix .pdf, ${Fig}))
figPrint = $(addprefix ${Dir}/, $(addsuffix print.tex, \
		${Fig} \
		))
figLilyPdf = $(addprefix ${Dir}/, $(addsuffix .pdf, ${figLily}))
figLilyPrint = $(addprefix ${Dir}/, $(addsuffix print.tex, ${figLily}))

########################################

all: ${Tgt}
	${MAKE} -C sample $@

clean:
	${RM} *~ fig/*~ ${Tgt} ${figPdf} ${figTYPdf} ${figPrint}
	${MAKE} -C sample $@

install:
	install -m 444 -pD ${Dir}/${Name}-ja.pdf \
		${InstallDir}/source/latex/${Name}/
	${MAKE} -C sample $@

########################################

# it should be already generated by upper make
# ${Dir}/${Name}.sty:

${Dir}/${Name}-ja.pdf: ${Tex} ${Dir}/${Name}.sty \
	${figPdf} ${figPrint} ${figLilyPdf} ${figLilyPdf}
	$(call Latex, ${Name}JA.tex)
	$(call Latex, ${Name}JA.tex)
#	$(call Latex, ${Name}JA.tex)
	cd ${Dir}; \
	${DVIPDFMX} -o $@ ${Name}JA.dvi
	ls -l $@

########################################

define MakeFigPdf # tgtname texname
	$(call Latex, ${2}.tex) && \
	cd ${Dir} && \
	${DVIPDFMX} ${2}.dvi && \
	${PDFCROP} ${2}.pdf $@ && \
	mv ${2}.dvi ${1}.dvi
endef

fig: ${figPdf} ${figLilyPdf}

${figTYPdf}: Lo += '\def\figsrc{$(basename $<)}'
${Dir}/%T.pdf: Lo += '\newif\ifmaketate\maketatetrue'
${Dir}/%Y.pdf: Lo += '\newif\ifmaketate\maketatefalse'
${Dir}/%T.pdf: fig/%.tex figTYJA.tex ${Dir}/${Name}.sty
	$(call MakeFigPdf,$(basename $@),figTYJA)
	ebb $@
${Dir}/%Y.pdf: fig/%.tex figTYJA.tex ${Dir}/${Name}.sty
	$(call MakeFigPdf,$(basename $@),figTYJA)
	ebb $@

${figPdf}: Lo = '\def\figsrc{$(notdir $(basename $@))}'
${figPdf}: ${Dir}/%.pdf: ${Dir}/%T.pdf ${Dir}/%Y.pdf figJA.tex
	$(call MakeFigPdf,$(basename $@),figJA)

########################################

define MakePrintTex # src
	grep -v '^%[^%]' ${1} |\
	tr '\n' '\r' |\
	sed -e 's/^\r\r*//' -e 's/\r\r*$$/\r/' |\
	tr '\r' '\n'
endef

untilComment = $(addprefix ${Dir}/, $(addsuffix print.tex, \
	fig1Ieyasu fig2Hidetada fig3Hidetada fig4Hidetada))
${untilComment}: ${Dir}/%print.tex: fig/%.tex
	sed -e '/^%$$/,$$d' $< | grep -v '^%' > $@

noIndvdl =  $(addprefix ${Dir}/, $(addsuffix print.tex, \
	fig2ival fig2cfg))
${noIndvdl}: ${Dir}/%print.tex: fig/%.tex
	fgrep -vw indvdldef $< |\
	fgrep -vx '' |\
	$(call MakePrintTex, -) > $@

# they should be already generated by upper make
# ${figLilyPdf} ${figLilyPrint}:

${Dir}/%Tprint.tex ${Dir}/%Yprint.tex: ${Dir}/%print.tex
	cp -p $< $@
${Dir}/%print.tex: fig/%.tex
	$(call MakePrintTex, $<) > $@

-include priv.mk
